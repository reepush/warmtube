<title>warmtube</title>
<meta charset="utf-8">

<div id='app'>
  <div class='chat'>
    <div class='chat__messages' v-for='message in messages'>
      <div class='chat__message' v-bind:style='{ color: message.color }'>{{message.content}}</div>
    </div>
    
    <input autofocus
           placeholder='you are nice'
           class='chat__input'
           v-model='input'
           v-on:keyup.enter='send'>
  </div>
  
  <div class='youtube'>
    <input placeholder='youtube'
           v-model='youtubeLinkInputPrimary'
           v-on:keyup.enter='postYoutubePrimary'>
           
    <input placeholder='youtube'
           v-model='youtubeLinkInputSecondary'
           v-on:keyup.enter='postYoutubeSecondary'>
           
    <youtube :video-id='youtubeIdPrimary' @ready='videoReady' @playing='videoPlaying' :player-vars='{ autoplay: 1 }'></youtube>
    <youtube :video-id='youtubeIdSecondary' :player-vars='{ autoplay: 1 }'></youtube>
  </div>
</div>

<style>
  .chat {
    width: 300px;
    margin: auto;
  }
  
  .chat__input {
    margin-top: 10px;
    width: 100%;
  }


  body {
    background-color: black;
  }
</style>


<script src="https://unpkg.com/vue@2.5.13/dist/vue.js"></script>
<script src="https://unpkg.com/vue-youtube-embed@2.1.3/lib/vue-youtube-embed.js"></script>
<script src="https://unpkg.com/socket.io-client@2.0.4/dist/socket.io.slim.js"></script>
<script>
  id = Math.random()
  Vue.use(VueYouTubeEmbed.default)
  
  var socket = io()
  socket.on('message', function (data) {
    if (pendingRequest) {
      pendingRequest = false
      return
    }
    
    console.error('Receiving', data)
    Object.assign(window.data, data)
  });

  socket.on('request', function (data) {
    if (pendingRequest) {
      pendingRequest = false
      return
    }
    
    notify()
  });

  pendingRequest = true
  socket.emit('request')

  function notify() {
    console.error('notify', id)
    pendingRequest = true
    socket.emit('message', {
      id: id,
      messages: window.data.messages,
      youtubeIdPrimary: window.data.youtubeIdPrimary,
      youtubeIdSecondary: window.data.youtubeIdSecondary,
      youtubeTime: window.data.youtubeTime,
    })
  }

  window.data = {
    color: ['yellow', 'green', 'orange', 'gold', 'purple'][Math.floor(Math.random() * 5)],
    input: '',
    youtubeLinkInputPrimary: '',
    youtubeLinkInputSecondary: '',
    
    youtubeIdPrimary: '',
    youtubeIdSecondary: '',
    youtubeTime: 0,
    messages: [],
    
    videoReady: function(player) {
      console.error('ready')
      player.playVideo()
    },
    
    videoPlayingInterval: null,
    videoPlaying: function(player) {
      console.error('playing')
      clearInterval(this.videoPlayingInterval)
      
      console.error(window.data.youtubeTime, player.getCurrentTime())
      if (Math.abs(window.data.youtubeTime - player.getCurrentTime()) > 1) {
        console.error('seeking')
        window.data.youtubeTime += 3
        player.seekTo(window.data.youtubeTime)
      }
      
      console.error('videoPlaying')
      this.videoPlayingInterval = setInterval(function() {
        window.data.youtubeTime = Math.round(player.getCurrentTime())
      }, 1000)
    },
    
    send: () => {
      window.data.messages.push({ content: window.data.input, color: window.data.color })
      window.data.input = ''
      notify()
    },
    postYoutubePrimary: () => {
      window.data.youtubeIdPrimary = VueYouTubeEmbed.getIdFromURL(window.data.youtubeLinkInputPrimary)
      window.data.youtubeLinkInputPrimary = ''
      notify()
    },
    postYoutubeSecondary: () => {
      window.data.youtubeIdSecondary = VueYouTubeEmbed.getIdFromURL(window.data.youtubeLinkInputSecondary)
      window.data.youtubeLinkInputSecondary = ''
      notify()
    },
  }

  window.app = new Vue({
    el: '#app',
    data: window.data
  })
</script>
